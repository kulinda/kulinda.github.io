(function(){'use strict';var Y=Math.max,H=Math.pow,W=Math.min,X=Math.PI,V=Math.sin,G=Math.cos,K=Math.sqrt,Z=Math.floor;function e(e){let t=e%16,r=Z(e/16),n=1/1024,o=64,a=16;return[(t*o+a)*n,(r*o+a)*n,(t*o+(o-a))*n,(r*o+(o-a))*n]}function t(e,t,r,o,a,i){let s=ue[t.read(o,a,i)];if(s.texture){let t=s.fluid&&r.get(o,a,i+1)!==s.id;for(const d of[q,Q,ee,te,re,ne]){let l=oe[d],u=r.get(o+l[0],a+l[1],i+l[2]),c=ue[u];if(!s.transparent&&!c.transparent&&!(d===q&&t))continue;let f=s.texture(o,a,i,d);if(null===f)continue;let p=s.vertex_coords||se;n(e,f,o,a,i,t?le[d]:p[d],d)}}}function r(e,t,r,o,a,i){for(const s of[q,Q,ee,te,re,ne]){let d=a,l=se;"object"==typeof a&&(d=a.texture(t,r,o,s),a.vertex_coords&&(l=a.vertex_coords)),null===d||n(e,d,t,r,o,l[s].map(e=>.5-(.5-e)*i),s)}}function n(t,r,n,o,a,i,s){let d=e(r),l=ie[s],u=oe[s];t.push(n+i[0],o+i[1],a+i[2],u[0],u[1],u[2],d[l[0]],d[l[1]],n+i[3],o+i[4],a+i[5],u[0],u[1],u[2],d[l[2]],d[l[3]],n+i[6],o+i[7],a+i[8],u[0],u[1],u[2],d[l[4]],d[l[5]],n+i[6],o+i[7],a+i[8],u[0],u[1],u[2],d[l[4]],d[l[5]],n+i[9],o+i[10],a+i[11],u[0],u[1],u[2],d[l[6]],d[l[7]],n+i[0],o+i[1],a+i[2],u[0],u[1],u[2],d[l[0]],d[l[1]])}function o(){var e=new fe(3);return fe!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function a(e){var t=new fe(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function i(e){var t=e[0],r=e[1],n=e[2];return K(t*t+r*r+n*n)}function s(e,t,r){var n=new fe(3);return n[0]=e,n[1]=t,n[2]=r,n}function d(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function l(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function u(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function c(e,t){return e[0]=Z(t[0]),e[1]=Z(t[1]),e[2]=Z(t[2]),e}function f(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function p(e,t){var r=t[0],n=t[1],o=t[2],a=r*r+n*n+o*o;return 0<a&&(a=1/K(a)),e[0]=t[0]*a,e[1]=t[1]*a,e[2]=t[2]*a,e}function g(e,t,r){var n=t[0],o=t[1],a=t[2],i=r[0],s=r[1],d=r[2];return e[0]=o*d-a*s,e[1]=a*i-n*d,e[2]=n*s-o*i,e}function m(e,t,r){var n=t[0],o=t[1],a=t[2],i=r[3]*n+r[7]*o+r[11]*a+r[15];return i=i||1,e[0]=(r[0]*n+r[4]*o+r[8]*a+r[12])/i,e[1]=(r[1]*n+r[5]*o+r[9]*a+r[13])/i,e[2]=(r[2]*n+r[6]*o+r[10]*a+r[14])/i,e}function _(e,t,n,o){var a=[],i=[];return a[0]=t[0]-n[0],a[1]=t[1]-n[1],a[2]=t[2]-n[2],i[0]=a[0]*G(o)-a[1]*V(o),i[1]=a[0]*V(o)+a[1]*G(o),i[2]=a[2],e[0]=i[0]+n[0],e[1]=i[1]+n[1],e[2]=i[2]+n[2],e}function h(e,t,r){return e=Z(e/_e),t=Z(t/_e),r=Z(r/_e),1073741824*r+32768*t+e}function v(e,t){return b(e)||E(e,t)||w()}function b(e){if(Array.isArray(e))return e}function E(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,s=e[Symbol.iterator]();!(n=(i=s.next()).done)&&(r.push(i.value),!(t&&r.length===t));n=!0);}catch(e){o=!0,a=e}finally{try{n||null==s["return"]||s["return"]()}finally{if(o)throw a}}return r}function w(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function I(){var e=new fe(16);return fe!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function x(e,t,r,n,o,a,i,s,d,l,u,c,f,p,g,m,_){return e[0]=t,e[1]=r,e[2]=n,e[3]=o,e[4]=a,e[5]=i,e[6]=s,e[7]=d,e[8]=l,e[9]=u,e[10]=c,e[11]=f,e[12]=p,e[13]=g,e[14]=m,e[15]=_,e}function T(e,t){var r=t[0],n=t[1],o=t[2],a=t[3],i=t[4],s=t[5],d=t[6],l=t[7],u=t[8],c=t[9],f=t[10],p=t[11],g=t[12],m=t[13],_=t[14],y=t[15],h=r*s-n*i,v=r*d-o*i,b=r*l-a*i,E=n*d-o*s,w=n*l-a*s,I=o*l-a*d,x=u*m-c*g,T=u*_-f*g,k=u*y-p*g,R=c*_-f*m,A=c*y-p*m,D=f*y-p*_,L=h*D-v*A+b*R+E*k-w*T+I*x;return L?(L=1/L,e[0]=(s*D-d*A+l*R)*L,e[1]=(o*A-n*D-a*R)*L,e[2]=(m*I-_*w+y*E)*L,e[3]=(f*w-c*I-p*E)*L,e[4]=(d*k-i*D-l*T)*L,e[5]=(r*D-o*k+a*T)*L,e[6]=(_*b-g*I-y*v)*L,e[7]=(u*I-f*b+p*v)*L,e[8]=(i*A-s*k+l*x)*L,e[9]=(n*k-r*A-a*x)*L,e[10]=(g*w-m*b+y*h)*L,e[11]=(c*b-u*w-p*h)*L,e[12]=(s*T-i*R-d*x)*L,e[13]=(r*R-n*T+o*x)*L,e[14]=(m*v-g*E-_*h)*L,e[15]=(u*E-c*v+f*h)*L,e):null}function k(e,t,r){var n=t[0],o=t[1],a=t[2],i=t[3],s=t[4],d=t[5],l=t[6],u=t[7],c=t[8],f=t[9],p=t[10],g=t[11],m=t[12],_=t[13],y=t[14],h=t[15],v=r[0],b=r[1],E=r[2],w=r[3];return e[0]=v*n+b*s+E*c+w*m,e[1]=v*o+b*d+E*f+w*_,e[2]=v*a+b*l+E*p+w*y,e[3]=v*i+b*u+E*g+w*h,v=r[4],b=r[5],E=r[6],w=r[7],e[4]=v*n+b*s+E*c+w*m,e[5]=v*o+b*d+E*f+w*_,e[6]=v*a+b*l+E*p+w*y,e[7]=v*i+b*u+E*g+w*h,v=r[8],b=r[9],E=r[10],w=r[11],e[8]=v*n+b*s+E*c+w*m,e[9]=v*o+b*d+E*f+w*_,e[10]=v*a+b*l+E*p+w*y,e[11]=v*i+b*u+E*g+w*h,v=r[12],b=r[13],E=r[14],w=r[15],e[12]=v*n+b*s+E*c+w*m,e[13]=v*o+b*d+E*f+w*_,e[14]=v*a+b*l+E*p+w*y,e[15]=v*i+b*u+E*g+w*h,e}function R(e,t,r){var n,o,a,i,s,d,l,u,c,f,p,g,m=r[0],_=r[1],y=r[2];return t===e?(e[12]=t[0]*m+t[4]*_+t[8]*y+t[12],e[13]=t[1]*m+t[5]*_+t[9]*y+t[13],e[14]=t[2]*m+t[6]*_+t[10]*y+t[14],e[15]=t[3]*m+t[7]*_+t[11]*y+t[15]):(n=t[0],o=t[1],a=t[2],i=t[3],s=t[4],d=t[5],l=t[6],u=t[7],c=t[8],f=t[9],p=t[10],g=t[11],e[0]=n,e[1]=o,e[2]=a,e[3]=i,e[4]=s,e[5]=d,e[6]=l,e[7]=u,e[8]=c,e[9]=f,e[10]=p,e[11]=g,e[12]=n*m+s*_+c*y+t[12],e[13]=o*m+d*_+f*y+t[13],e[14]=a*m+l*_+p*y+t[14],e[15]=i*m+u*_+g*y+t[15]),e}function A(e,r,n,o){var a,i,d,l,u,f,p,g,m,_,h,v,b,E,w,I,T,k,R,A,D,L,B,C,M=o[0],U=o[1],S=o[2],P=K(M*M+U*U+S*S);return P<ce?null:(P=1/P,M*=P,U*=P,S*=P,a=V(n),i=G(n),d=1-i,l=r[0],u=r[1],f=r[2],p=r[3],g=r[4],m=r[5],_=r[6],h=r[7],v=r[8],b=r[9],E=r[10],w=r[11],I=M*M*d+i,T=U*M*d+S*a,k=S*M*d-U*a,R=M*U*d-S*a,A=U*U*d+i,D=S*U*d+M*a,L=M*S*d+U*a,B=U*S*d-M*a,C=S*S*d+i,e[0]=l*I+g*T+v*k,e[1]=u*I+m*T+b*k,e[2]=f*I+_*T+E*k,e[3]=p*I+h*T+w*k,e[4]=l*R+g*A+v*D,e[5]=u*R+m*A+b*D,e[6]=f*R+_*A+E*D,e[7]=p*R+h*A+w*D,e[8]=l*L+g*B+v*C,e[9]=u*L+m*B+b*C,e[10]=f*L+_*B+E*C,e[11]=p*L+h*B+w*C,r!==e&&(e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15]),e)}function D(e,t,r,n,o){var i,a=Math.tan,s=1/a(t/2);return e[0]=s/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=o&&o!==1/0?(i=1/(n-o),e[10]=(o+n)*i,e[14]=2*o*n*i):(e[10]=-1,e[14]=-2*n),e}function L(e){let t=K(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]/=t,e[1]/=t,e[2]/=t,e[3]/=t}function B(e,t,r){let n=e.createShader(r);if(e.shaderSource(n,t),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))throw new Error("could not compile shader!\n"+e.getShaderInfoLog(n));return n}function C(e){this.array=[],this.size=0,this.compare=e||Ae}function M(e,t){this.canvas=e,e.width=e.clientWidth,e.height=e.clientHeight;let r;try{r=e.getContext("webgl")}catch(t){console.error(t)}if(!r)throw new Error("Your browser does not support WebGL!");this.gl=r,this.perspective=[60/180*X,.01,250],r.enable(r.DEPTH_TEST),r.cullFace(r.FRONT),this.program_blocks=new Te(this.gl),this.program_water=new ke(this.gl),this.program_stars=new Re(this.gl),this.texture_blocks=new xe(this.gl,t,function(){let e=this.gl;e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)}),this.projMatrix=I(),this.viewMatrix=I(),this.projViewMatrix=I()}function U(e,t,r){let n=r.intersectsSphere(t.center,1.73205080757*(t.size/2));if(!1!==n&&(t.values&&e.add([n,t]),t.children))for(let n of t.children)n&&U(e,n,r)}function S(t){t.preventDefault(),t.stopPropagation()}function P(e){this.world=e,this.pos=a(e.spawnPoint),this.angles=s(0,X/2,0),this.velocity=s(0,0,0),this.falling=!1,this.buildDestroy=!0,this.buildMaterial=1,this.crackedBlocks=new Map,this.last_block_placement_tick=0}function F(e,t){return e?t?e.dist<=t.dist?e:t:e:t}function N(e){e=16;let t=s(1,1,1),r=a(Ue[2]),n=2*X*(e/24),o=s(V(n),V(n),G(n+X));return p(o,o),{ambient:t,sky:r,sunpos:o}}function O(){function e(e,t,r){u(s,e,r),u(d,t,r),g(l,s,d),p(l,l),i.push(e[0],e[1],e[2],l[0],l[1],l[2]),i.push(t[0],t[1],t[2],l[0],l[1],l[2]),i.push(r[0],r[1],r[2],l[0],l[1],l[2])}const t=5;let r=[],n=[[0,-.15,0],[0,+.15,0]];for(let e=0;e<t;e++){let t=e*(2*X/5),n=G(t)/2,o=V(t)/2;r.push([o,0,n])}let i=[],s=o(),d=o(),l=o();for(let o=0;o<t;o++){let a=r[o],i=r[(o+2)%t];e(i,a,n[0]),e(a,i,n[1])}return new Float32Array(i)}function z(t){console.error(t);let e=t;t||(e="Unknown error"),"object"==typeof t&&"string"==typeof t.message&&(e=t.message),document.getElementById("loading_progress").textContent=`Error loading game.\n${e}\nThis game is tested on Firefox and Chrome on a desktop computer.`}function j(){for(let e of["requestAnimationFrame","Float32Array"])if("function"!=typeof window[e])return z("Your browser is too old."),!1;return!0}const q=0,J=0,Q=1,$=1,ee=2,te=3,re=4,ne=5,oe=[];oe[te]=[1,0,0],oe[ee]=[-1,0,0],oe[ne]=[0,1,0],oe[re]=[0,-1,0],oe[J]=[0,0,1],oe[$]=[0,0,-1];const ae=0,ie=[];ie[te]=[0,3,2,3,2,1,0,1],ie[ee]=[2,1,0,1,0,3,2,3],ie[ne]=[2,1,0,1,0,3,2,3],ie[re]=[0,3,2,3,2,1,0,1],ie[J]=[0,1,2,1,2,3,0,3],ie[$]=[0,3,2,3,2,1,0,1];const se=[];se[te]=[1,0,0,1,1,0,1,1,1,1,0,1],se[ee]=[0,0,1,0,1,1,0,1,0,0,0,0],se[ne]=[0,1,1,1,1,1,1,1,0,0,1,0],se[re]=[0,0,0,1,0,0,1,0,1,0,0,1],se[J]=[0,0,1,1,0,1,1,1,1,0,1,1],se[$]=[0,1,0,1,1,0,1,0,0,0,0,0];const de=[];de[te]=[.5,0,0,.5,1,0,.5,1,1,.5,0,1],de[ee]=[.5,0,1,.5,1,1,.5,1,0,.5,0,0],de[ne]=[0,.5,1,1,.5,1,1,.5,0,0,.5,0],de[re]=[0,.5,0,1,.5,0,1,.5,1,0,.5,1],de[J]=[0,0,.5,1,0,.5,1,1,.5,0,1,.5],de[$]=[0,1,.5,1,1,.5,1,0,.5,0,0,.5];const le={};for(let e in se){let t=se[e];le[e]=t.map((e,t)=>2==t%3&&.5<e?.75:e)}let ue={};ue[0]={id:0,transparent:!0},function(){for(let e=0;45>e;e++){let t=e+1,r=4*(e+1);ue[t]={id:t,transparent:!1,selflit:!1,gravity:!1,fluid:!1,texture:function(){return r}}}ue.length=46}(),ue[ue.length]={id:ue.length,transparent:!0,selflit:!1,gravity:!1,fluid:!1,texture:function(e,t,r,n){return n===te||n===ee?230:null},vertex_coords:de},ue.length++,ue[ue.length]={id:ue.length,transparent:!0,selflit:!1,gravity:!1,fluid:!1,texture:function(e,t,r,n){return n===ne||n===re?230:null},vertex_coords:de},ue.length++,ue[ue.length]={id:ue.length,transparent:!0,selflit:!1,gravity:!1,fluid:!0,texture:function(){return 220}},ue.length++,ue[ue.length]={id:ue.length,transparent:!1,selflit:!1,gravity:!1,fluid:!1,texture:function(){return 210}},ue.length++,ue[ue.length]={id:ue.length,transparent:!1,selflit:!1,gravity:!1,fluid:!1,texture:function(){return 209}},ue.length++;var ce=1e-6,fe="undefined"==typeof Float32Array?Array:Float32Array,pe=function(){var e=o();return function(t,r,n,o,a,s){var d,u;for(r||(r=3),n||(n=0),u=o?W(o*r+n,t.length):t.length,d=n;d<u;d+=r)e[0]=t[d],e[1]=t[d+1],e[2]=t[d+2],a(e,e,s),t[d]=e[0],t[d+1]=e[1],t[d+2]=e[2];return t}}();const ge=4,me=0,_e=H(2,4);class ye{constructor(e,t,r,n,o){if(t<ge)throw new Error("Octree: cannot create node smaller than min level");if(t>20)throw new Error("Octree: cannot create node larger than max level");let a=H(2,t),i=a/2;if(r%i||n%i||o%i)throw console.log(t,a,i,r,n,o),new Error("Octree: center is not aligned properly");this.root=e,this.level=t,this.size=a,this.radius=i,this.center=[r,n,o]}contains(e,t,r){let n=this.center,o=this.radius;return!(e<n[0]-o||e>=n[0]+o)&&!(t<n[1]-o||t>=n[1]+o)&&!(r<n[2]-o||r>=n[2]+o)}}class he{constructor(e,t,r){let n=Y(e,t,r),o=Math.ceil(Math.log2(n));o=Y(5,o),this.root=new ve(this,o,0,0,0),this.size=[e,t,r],this._leafs=new Map}get(e,t,r){let n=this._leafs.get(h(e,t,r));return n?n.read(e,t,r):me}set(e,t,r,n){let o=h(e,t,r),a=this._leafs.get(o);if(!a){if(n===me)return;a=this.root.addLeaf(e,t,r),this._leafs.set(o,a)}a.write(e,t,r,n)}_findLeaf(e,t,r){return this._leafs.get(h(e,t,r))}}class ve extends ye{constructor(e,t){let r=2<arguments.length&&arguments[2]!==void 0?arguments[2]:0,n=3<arguments.length&&arguments[3]!==void 0?arguments[3]:0,o=4<arguments.length&&arguments[4]!==void 0?arguments[4]:0;super(e,t,r,n,o),this.children=null}addLeaf(e,t,r){if(!this.contains(e,t,r))throw new Error("addLeaf: trying to add outside of bb");this.children||(this.children=[null,null,null,null,null,null,null,null]);let n=this._pickChildFromCoords(e,t,r);if(!this.children[n]){let e=this.size/4,t=this.center[0]+e*(1&n?-1:1),r=this.center[1]+e*(2&n?-1:1),o=this.center[2]+e*(4&n?-1:1);if(this.level-1<=ge){let e=new be(this.root,t,r,o);return this.children[n]=e,e}this.children[n]=new ve(this.root,this.level-1,t,r,o)}let o=this.children[n];if(o instanceof be)throw new Error("addLeaf: leaf already exists");return o.addLeaf(e,t,r)}_pickChildFromCoords(e,t,r){let n=0;return r<this.center[2]&&(n+=4),t<this.center[1]&&(n+=2),e<this.center[0]&&(n+=1),n}}class be extends ye{constructor(e){let t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0,r=2<arguments.length&&arguments[2]!==void 0?arguments[2]:0,n=3<arguments.length&&arguments[3]!==void 0?arguments[3]:0;super(e,ge,t,r,n),this.adjacent_leafs=[null,null,null,null,null,null],this.values=new Int8Array(this.size*this.size*this.size),this.values.fill(me),this.dirty=!0,this.buffer=null,this.buffer_count=0}findAdjacentLeaf(e){if(0>e||6<=e)throw new Error("Octree: findAdjacentLeaf, invalid direction"+e);if(!this.adjacent_leafs[e]){let t=oe[e],r=t[0]*this.size+this.center[0],n=t[1]*this.size+this.center[1],o=t[2]*this.size+this.center[2],a=this.root._findLeaf(r,n,o);a&&(this.adjacent_leafs[e]=a)}return this.adjacent_leafs[e]}_markAdjacentLeafDirty(e){let t=this.findAdjacentLeaf(e);t&&(t.dirty=!0)}read(e,t,r){let n=this.size,o=n/2,a=n*n*(r-(this.center[2]-o))+n*(t-(this.center[1]-o))+(e-(this.center[0]-o));if(0>a||a>this.values.length)throw console.log(e,t,r,this.center,this.size,o,a,this.values.length,this.size*this.size*this.size),new Error("Octree: read out of bounds");return this.values[a]}write(e,t,r,n){let o=this.size,a=o/2,i=o*o*(r-(this.center[2]-a))+o*(t-(this.center[1]-a))+(e-(this.center[0]-a));if(0>i||i>this.values.length)throw console.log(e,t,r,this.center,this.size,a,i,this.values.length,this.size*this.size*this.size),new Error("Octree: write out of bounds");this.values[i]!==n&&(this.values[i]=n,this.dirty=!0,e===this.center[0]-a&&this._markAdjacentLeafDirty(ee),e===this.center[0]+a-1&&this._markAdjacentLeafDirty(te),t===this.center[1]-a&&this._markAdjacentLeafDirty(re),t===this.center[1]+a-1&&this._markAdjacentLeafDirty(ne),r===this.center[2]-a&&this._markAdjacentLeafDirty($),r===this.center[2]+a-1&&this._markAdjacentLeafDirty(J))}}class Ee{constructor(){this.tree=null,this.size=null}createEmptyWorld(e,t,r){this.tree=new he(e,t,r),this.size=[e,t,r]}get(e,t,r){return this.tree.get(e,t,r)}set(e,t,r,n){return this.tree.set(e,t,r,n)}traceVector(e,t){e=a(e),t=a(t);let r=[],n=o();u(n,t,e);let i=o();for(let r=0;3>r;r++)i[r]=0>n[r]?-1:0<n[r]?1:0;let l=0,f=o();c(f,e);let p=o();c(p,t);let g=o(),m=s(0,0,0);for(;;){if(0<r.length){let e=r[r.length-1];if(e[0]===f[0]&&e[1]===f[1]&&e[2]===f[2])return console.error("traceVector: failed to move"),null}let o=this.get(f[0],f[1],f[2]);if(o){let e=[g[0]-f[0],g[1]-f[1],g[2]-f[2]];return 0==l&&(e=[0,0,0]),{x:f[0],y:f[1],z:f[2],face:e,dist:W(m[0],m[1],m[2])}}if(f[0]===p[0]&&f[1]===p[1]&&f[2]===p[2])return null;d(g,f);for(let t=0;3>t;t++)if(0===i[t])m[t]=1/0;else{let r=f[t]+(0<n[t]?1:0);m[t]=(r-e[t])/n[t]}r.push([...f,...m]),m[0]<m[1]&&m[0]<m[2]?f[0]+=i[0]:m[1]<m[2]?f[1]+=i[1]:f[2]+=i[2];let a=W(m[0],m[1],m[2]);if(1<a&&console.warn("min > 1.0",a),f[0]===g[0]&&f[1]===g[1]&&f[2]===g[2])return console.error("traceVector: failed to move"),console.log([...g],[...f],[...i],[...m]),null;if(100<l++)return console.error("traceVector failed",e,t,n),console.error(r),null}return null}}class we{constructor(e){this.planes=[],this.planes[0]=Float32Array.of(e[3]-e[0],e[7]-e[4],e[11]-e[8],e[15]-e[12]),this.planes[1]=Float32Array.of(e[3]+e[0],e[7]+e[4],e[11]+e[8],e[15]+e[12]),this.planes[2]=Float32Array.of(e[3]-e[1],e[7]-e[5],e[11]-e[9],e[15]-e[13]),this.planes[3]=Float32Array.of(e[3]+e[1],e[7]+e[5],e[11]+e[9],e[15]+e[13]),this.planes[4]=Float32Array.of(e[3]-e[2],e[7]-e[6],e[11]-e[10],e[15]-e[14]),this.planes[5]=Float32Array.of(e[3]+e[2],e[7]+e[6],e[11]+e[10],e[15]+e[14]);for(let t=0;6>t;t++)L(this.planes[t])}intersectsPoint(e){return this.intersectsSphere(e,0)}intersectsSphere(e,t){let r;for(let n of this.planes)if(r=n[0]*e[0]+n[1]*e[1]+n[2]*e[2]+n[3],r<-t)return!1;return r}}class Ie{constructor(e,t,r){this.gl=e;let n=e.createProgram(),o=B(e,t,e.VERTEX_SHADER),a=B(e,r,e.FRAGMENT_SHADER);if(e.attachShader(n,o),e.attachShader(n,a),e.linkProgram(n),!e.getProgramParameter(n,e.LINK_STATUS))throw new Error("Could not link the shader program!\n"+e.getProgramInfoLog(n));e.useProgram(n);let s={},d=e.getProgramParameter(n,e.ACTIVE_UNIFORMS);for(let o=0;o<d;o++){let t=e.getActiveUniform(n,o),r=e.getUniformLocation(n,t.name);s[t.name]=r}let l={},u=e.getProgramParameter(n,e.ACTIVE_ATTRIBUTES);for(let o=0;o<u;o++){let t=e.getActiveAttrib(n,o),r=e.getAttribLocation(n,t.name);l[t.name]=r}this.program=n,this.u=s,this.a=l}use(){for(let e in this.gl.useProgram(this.program),this.a)this.gl.enableVertexAttribArray(this.a[e])}stopUsing(){for(let e in this.a)this.gl.disableVertexAttribArray(this.a[e])}}class xe{constructor(e,t,r){this.gl=e,this.loaded=!1,this.error=!1,this.done=r,this.tex=e.createTexture(),t instanceof HTMLImageElement?(this.img=t,this.onLoad()):(this.img=new Image,this.img.onload=this.onLoad.bind(this),this.img.onerror=this.onError.bind(this),this.img.src=t)}onLoad(){let e=this.gl;e.bindTexture(e.TEXTURE_2D,this.tex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.img),this.img=null,this.loaded=!0,this.done&&(this.done(),this.done=null),e.bindTexture(e.TEXTURE_2D,null)}onError(t){this.error=!0,console.error(t)}loaded(){return!this.error&&this.loaded}}class Te extends Ie{constructor(e){super(e,`
uniform mat4 uProjMatrix;
uniform mat4 uViewMatrix;
attribute vec3 aPos;
attribute vec3 aNormal;
attribute vec2 aTexCoord;
varying vec3 vNormal;
varying vec2 vTexCoord;
varying vec3 vPosition;
void main() {
	vec4 viewPos = uViewMatrix * vec4(aPos, 1.0);
	gl_Position = uProjMatrix * viewPos;
	vNormal = aNormal;
	vTexCoord = aTexCoord;
	vPosition = viewPos.xyz;
}`,`
precision highp float;

uniform vec3 uSunColor;
uniform vec3 uSunPosition;
uniform vec3 uFogColor;
uniform vec2 uFogDistance;

uniform sampler2D uSampler;
varying vec3 vNormal;
varying vec2 vTexCoord;
varying vec3 vPosition;
void main() {
	float diffuseIntensity = max(dot(vNormal, uSunPosition), 0.0);
	vec3 lightColor = 0.5 * uSunColor + diffuseIntensity * uSunColor;
	lightColor = clamp(lightColor, 0.0, 1.0);
	vec4 color = texture2D(uSampler, vec2(vTexCoord.s, vTexCoord.t)) * vec4(lightColor.rgb, 1.0);
	if (color.a < 0.01)
		discard;
	float distance = length(vPosition);
	float fog = smoothstep(uFogDistance.x, uFogDistance.y, distance);
	color.rgb = mix(color.rgb, uFogColor, fog);
	gl_FragColor = vec4(color.rgb, 1.0);
}`)}drawBuffer(e,t){let r=this.gl,n=this.a;r.bindBuffer(r.ARRAY_BUFFER,e);r.vertexAttribPointer(n.aPos,3,r.FLOAT,!1,32,0),r.vertexAttribPointer(n.aNormal,3,r.FLOAT,!1,32,12),r.vertexAttribPointer(n.aTexCoord,2,r.FLOAT,!1,32,24),r.enable(r.CULL_FACE),r.drawArrays(r.TRIANGLES,0,t),r.disable(r.CULL_FACE)}}class ke extends Ie{constructor(e){super(e,`
uniform mat4 uProjMatrix;
uniform mat4 uViewMatrix;
attribute vec3 aPos;
attribute vec4 aColor;
varying vec4 vColor;
varying vec3 vPosition;
void main() {
	vec4 viewPos = uViewMatrix * vec4( aPos, 1.0);
	gl_Position = uProjMatrix * viewPos;
	vColor = aColor;
	vPosition = viewPos.xyz;
}`,`
precision highp float;
uniform vec2 uFogDistance;
varying vec4 vColor;
varying vec3 vPosition;
void main() {
	float distance = length(vPosition);
	float fog = smoothstep(uFogDistance.x, uFogDistance.y, distance);
	gl_FragColor = vec4(vColor.rgb, (1.0 - fog) * vColor.a);
}`)}drawBuffer(e,t){let r=this.gl,n=this.a;r.bindBuffer(r.ARRAY_BUFFER,e);r.vertexAttribPointer(n.aPos,3,r.FLOAT,!1,28,0),r.vertexAttribPointer(n.aColor,4,r.FLOAT,!1,28,12),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.drawArrays(r.TRIANGLES,0,t),r.disable(r.BLEND)}}class Re extends Ie{constructor(e){super(e,`
uniform mat4 uProjMatrix;
uniform mat4 uViewMatrix;
uniform vec3 uPosition;
uniform float uRotation;
attribute vec3 aPos;
attribute vec3 aNormal;
varying vec3 vNormal;
varying vec3 vPosition;
void main() {
	vec3 rotPos = vec3(
		aPos.x * cos(uRotation) - aPos.y * sin(uRotation),
		aPos.x * sin(uRotation) + aPos.y * cos(uRotation),
		aPos.z
	);
	vec4 viewPos = uViewMatrix * vec4(rotPos + uPosition + 0.5, 1.0);
	gl_Position = uProjMatrix * viewPos;
	vPosition = viewPos.xyz;
	vNormal = aNormal;
}`,`
precision highp float;
uniform vec3 uSunColor;
uniform vec3 uSunPosition;
uniform vec3 uFogColor;
uniform vec2 uFogDistance;
varying vec3 vNormal;
varying vec3 vPosition;
void main() {
	float diffuseIntensity = max(dot(vNormal, uSunPosition), 0.0);
	vec3 lightColor = 0.5 * uSunColor + diffuseIntensity * uSunColor;
	lightColor = clamp(lightColor, 0.0, 1.0);
	vec3 color = vec3(1.0, 1.0, 0.0) * lightColor;
	float distance = length(vPosition);
	float fog = smoothstep(uFogDistance.x, uFogDistance.y, distance);
	color.rgb = mix(color.rgb, uFogColor, fog);
	gl_FragColor = vec4(color.rgb, 1.0);
}`)}drawBuffer(e,t){let r=this.gl,n=this.a;r.bindBuffer(r.ARRAY_BUFFER,e);r.vertexAttribPointer(n.aPos,3,r.FLOAT,!1,24,0),n.aNormal&&r.vertexAttribPointer(n.aNormal,3,r.FLOAT,!1,24,12),r.enable(r.CULL_FACE),r.drawArrays(r.TRIANGLES,0,t),r.disable(r.CULL_FACE)}}var Ae=function(e,t){return e<t};C.prototype.add=function(e){var t=this.size;this.array[this.size]=e,this.size+=1;for(var r,n;0<t&&(r=t-1>>1,n=this.array[r],!!this.compare(e,n));)this.array[t]=n,t=r;this.array[t]=e},C.prototype._percolateDown=function(e){for(var t,n,o,a=this.size,s=this.size>>>1,d=this.array[e];e<s&&(t=(e<<1)+1,n=t+1,o=this.array[t],n<a&&this.compare(this.array[n],o)&&(t=n,o=this.array[n]),!!this.compare(o,d));)this.array[e]=o,e=t;this.array[e]=d},C.prototype.poll=function(){if(0!=this.size){var e=this.array[0];return 1<this.size?(this.array[0]=this.array[--this.size],this._percolateDown(0)):this.size-=1,e}},C.prototype.isEmpty=function(){return 0===this.size},M.prototype.prepareDraw=function(e,t,r){const n=this.gl,o=this.canvas;(o.width!==o.clientWidth||o.height!==o.clientHeight)&&(o.width=o.clientWidth,o.height=o.clientHeight);let a=this.perspective;D(this.projMatrix,a[0],n.drawingBufferWidth/n.drawingBufferHeight,a[1],a[2]);let i=this.viewMatrix;x(i,0,0,-1,0,1,0,0,0,0,1,0,0,0,0,0,1),A(i,i,t[0],[0,1,0]),A(i,i,-t[1],[0,0,1]),R(i,i,[-e[0],-e[1],-e[2]]),k(this.projViewMatrix,this.projMatrix,this.viewMatrix),this.frustum=new we(this.projViewMatrix),this.sky=r,n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight);let s=this.sky.sky;n.clearColor(s[0],s[1],s[2],1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT)},M.prototype.drawChunks=function(e){const t=this.gl;let r=this.program_blocks;r.use();let n=this.perspective[2];t.uniformMatrix4fv(r.u.uProjMatrix,!1,this.projMatrix),t.uniformMatrix4fv(r.u.uViewMatrix,!1,this.viewMatrix),t.uniform3fv(r.u.uSunColor,this.sky.ambient),t.uniform3fv(r.u.uSunPosition,this.sky.sunpos),t.uniform3fv(r.u.uFogColor,this.sky.sky),t.uniform2fv(r.u.uFogDistance,[.85*n,n]),t.uniform1i(r.u.uSampler,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.texture_blocks.tex),this.nodes_drawn=0,this.nodes_missing=0,this.nodes_rebuilt=0;let o=this.frustum,a=new C((e,t)=>e[0]<t[0]);U(a,e.tree.root,o);for(let t;t=a.poll();)t=t[1],t.dirty&&5>this.nodes_rebuilt&&(this.nodes_rebuilt++,this.buildChunk(e,t)),t.buffer?(this.nodes_drawn++,r.drawBuffer(t.buffer,t.buffer_count)):t.dirty&&this.nodes_missing++},M.prototype.drawMarkers=function(e,t,n){let o=this.gl,a=this.program_blocks,i=[];e&&(0!==t&&r(i,e.x,e.y,e.z,ue[t],1),r(i,e.x,e.y,e.z,255,1.1));for(let o of n){var s=v(o,2);let e=s[0],t=s[1],n=Math.round(9*(t.v/1e3));n=Y(0,n),n=W(9,n),r(i,t.x,t.y,t.z,n+0+240,1.05)}if(0<i.length){let e=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,e),o.bufferData(o.ARRAY_BUFFER,new Float32Array(i),o.STATIC_DRAW),a.drawBuffer(e,i.length/8),o.deleteBuffer(e)}o.bindTexture(o.TEXTURE_2D,null),a.stopUsing()},M.prototype.drawWater=function(e){let t=this.gl,r=this.program_water;r.use();let n=this.perspective[2];t.uniformMatrix4fv(r.u.uProjMatrix,!1,this.projMatrix),t.uniformMatrix4fv(r.u.uViewMatrix,!1,this.viewMatrix),t.uniform2fv(r.u.uFogDistance,[.85*n,n]);let o=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,o);let i=.5,a=-e[0]/2,s=+e[0]/2,d=-e[1]/2,l=+e[1]/2;t.bufferData(t.ARRAY_BUFFER,new Float32Array([a,d,.5,0,0,1,i,s,d,.5,0,0,1,i,a,l,.5,0,0,1,i,a,l,.5,0,0,1,i,s,d,.5,0,0,1,i,s,l,.5,0,0,1,i]),t.STATIC_DRAW),r.drawBuffer(o,6),t.deleteBuffer(o),r.stopUsing()},M.prototype.drawStars=function(e,t){const r=this.gl;let n=this.program_stars;if(n.use(),!e.buffer){let t=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,t),r.bufferData(r.ARRAY_BUFFER,e.mesh,r.STATIC_DRAW),e.buffer=t}let o=this.perspective[2];r.uniformMatrix4fv(n.u.uProjMatrix,!1,this.projMatrix),r.uniformMatrix4fv(n.u.uViewMatrix,!1,this.viewMatrix),r.uniform3fv(n.u.uSunColor,this.sky.ambient),r.uniform3fv(n.u.uSunPosition,this.sky.sunpos),r.uniform3fv(n.u.uFogColor,this.sky.sky),r.uniform2fv(n.u.uFogDistance,[.85*o,o]);let a=e.stars.length;for(let o=0;o<a;o++){if(e.found[o])continue;let a=e.stars[o];r.uniform3fv(n.u.uPosition,[a[0],a[1],a[2]+.85]),r.uniform1f(n.u.uRotation,t/1e3%(2*X)),n.drawBuffer(e.buffer,e.mesh_count)}n.stopUsing()},M.prototype.drawCollisions=function(e){},M.prototype.finishDraw=function(){this.gl.finish()},M.prototype.buildChunk=function(e,r){if(!r.dirty)return;r.dirty=!1;let n=this.gl;if(r.buffer&&(n.deleteBuffer(r.buffer),r.buffer=null),r.children)return;let o=[],a=r.size,i=a/2;for(let n=r.center[0]-i;n<r.center[0]+i;n++)for(let a=r.center[1]-i;a<r.center[1]+i;a++)for(let s,d=r.center[2]-i;d<r.center[2]+i;d++)s=r.read(n,a,d),s===ae||t(o,r,e,n,a,d);if(0<o.length){let e=r.buffer=n.createBuffer();r.buffer_count=o.length/8,n.bindBuffer(n.ARRAY_BUFFER,e),n.bufferData(n.ARRAY_BUFFER,new Float32Array(o),n.STATIC_DRAW)}else r.buffer=!1},M.prototype.setPerspective=function(e,t,r){this.perspective[0]=e,this.perspective[1]=t,this.perspective[2]=r},M.prototype.getClickPosition=function(e,t){if(e/=this.gl.drawingBufferWidth,t/=this.gl.drawingBufferHeight,e=2*e-1,t=-(2*t-1),-1>e||1<e||-1>t||1<t)return null;let r=s(e,t,1),n=I();return(n=T(n,this.projViewMatrix),!n)?null:(m(r,r,n),r)};const De=0,Le=2;class Be{constructor(e,t){this.element=e,this.player=t,this.keys={w:0,a:0,s:0,d:0," ":0,shift:0},this.mouse=[-1,-1],this.lastmouse=[-1,-1],this.mousebuttons=[!1,!1],this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseOut=this.onMouseOut.bind(this),this.hotkeys=[],this.hotkeys_callbacks=[],this.running=!1,this.attached=!1,this.attach()}attach(){this.attached||(this.attached=!0,document.addEventListener("keydown",this.onKeyDown,!1),document.addEventListener("keyup",this.onKeyUp,!1),this.element.addEventListener("mouseup",this.onMouseUp,!1),this.element.addEventListener("mousedown",this.onMouseDown,!1),this.element.addEventListener("mousemove",this.onMouseMove,!1),this.element.addEventListener("mouseout",this.onMouseOut,!1),this.element.addEventListener("contextmenu",S,!1))}detach(){this.attached&&(this.attached=!1,document.removeEventListener("keydown",this.onKeyDown,!1),document.removeEventListener("keyup",this.onKeyUp,!1),this.element.removeEventListener("mouseup",this.onMouseUp,!1),this.element.removeEventListener("mousedown",this.onMouseDown,!1),this.element.removeEventListener("mousemove",this.onMouseMove,!1),this.element.removeEventListener("mouseout",this.onMouseOut,!1),this.element.removeEventListener("contextmenu",S,!1))}addHotkey(e,t){this.hotkeys.push(e),this.hotkeys_callbacks.push(t)}getMovement(){let e=1*this.keys.w+-1*this.keys.s,t=1*this.keys.d+-1*this.keys.a,r=this.keys[" "];return{fwd:e,side:t,running:this.running,jump:r}}onKeyDown(t){let e=t.key.toLowerCase();if("r"===e){this.running=!this.running;let t=document.getElementById("run");t&&t.classList.toggle("highlight",this.running)}else if(-1<["1","2","3"].indexOf(e)){this.player.setBuildMaterial([null,-1,1][+e-1])}else if(-1<["w","a","s","d"," "].indexOf(e))this.keys[e]=1;else if(-1<this.hotkeys.indexOf(e)){let t=this.hotkeys.indexOf(e);this.hotkeys_callbacks[t]()}else return;t.preventDefault()}onKeyUp(t){let e=t.key.toLowerCase();if(-1<["w","a","s","d"," "].indexOf(e))this.keys[e]=0;else return;t.preventDefault()}getMousePos(t){let e=this.element.getBoundingClientRect();this.mouse[0]=t.clientX-e.left,this.mouse[1]=t.clientY-e.top}onMouseDown(t){t.preventDefault(),this.getMousePos(t),t.button===De?this.mousebuttons[0]=!0:t.button===Le&&(this.mousebuttons[1]=!0,this.lastmouse[0]=this.mouse[0],this.lastmouse[1]=this.mouse[1],this.element.style.cursor="move")}onMouseUp(t){t.preventDefault(),this.getMousePos(t),t.button===De?this.mousebuttons[0]=!1:t.button===Le&&(this.mousebuttons[1]=!1,this.element.style.cursor="")}onMouseMove(t){if(t.preventDefault(),this.getMousePos(t),this.mousebuttons[1]){let e=this.mouse[0]-this.lastmouse[0],t=this.mouse[1]-this.lastmouse[1];this.lastmouse[0]=this.mouse[0],this.lastmouse[1]=this.mouse[1],this.player.turn(e,t)}}onMouseOut(){this.mouse[0]=-1,this.mouse[1]=-1,this.mousebuttons[0]=!1,this.mousebuttons[1]=!1}}const Ce=1.85,Me=.5;P.prototype.setBuildMaterial=function(e){if(!e)this.buildDestroy=!0;else if(this.buildDestroy)this.buildDestroy=!1;else{let t=ue.length-1,r=(this.buildMaterial-1+t+e)%t+1;this.buildMaterial=r}},P.prototype.turn=function(e,t){this.angles[0]-=t/200,this.angles[1]+=e/200,this.angles[0]<-X/2&&(this.angles[0]=-X/2),this.angles[0]>X/2&&(this.angles[0]=X/2)},P.prototype.interactWithBlock=function(e,t,r){if(e)if(this.buildDestroy){let r=e.x+"_"+e.y+"_"+e.z,n=this.crackedBlocks.get(r)||{x:e.x,y:e.y,z:e.z,v:0};n.v+=2*t,1e3<n.v?(this.crackedBlocks.delete(r),this.world.set(e.x,e.y,e.z,ae)):this.crackedBlocks.set(r,n)}else{if(e.x===Z(this.pos[0])&&e.y===Z(this.pos[1])&&e.z===Z(this.pos[2]))return;r>=this.last_block_placement_tick+200&&(this.world.set(e.x,e.y,e.z,this.buildMaterial),this.last_block_placement_tick=r)}},P.prototype.update=function(e,t){var r=Math.abs;const n=this.world,a=this.velocity,i=this.pos,d=o();c(d,i);for(let r of this.crackedBlocks){var l=v(r,2);let t=l[0],n=l[1];n.v-=e,0>n.v&&this.crackedBlocks.delete(t)}this.falling&&(a[2]+=-(e/50)),t.jump&&!this.falling&&(a[2]=8);let u=s(t.fwd,t.side,0);_(u,u,[0,0,0],this.angles[1]),p(u,u);let g=t.running?10:5;f(u,u,g);let m=W(1,.01*e);this.falling&&(m/=2),a[0]=(1-m)*a[0]+m*u[0],a[1]=(1-m)*a[1]+m*u[1],.001>r(a[0])+r(a[1])&&(a[0]=a[1]=0),this.move(this.velocity[0]*e/1e3,this.velocity[1]*e/1e3),this.fall(this.velocity[2]*e/1e3)},P.prototype.move=function(e,t){var r=Math.sign;let n=this.pos,a=o(),s=o(),d=[-Me/2,0,0,Me/2,0,0,0,-Me/2,0,0,Me/2,0,-Me/2,0,Ce,Me/2,0,Ce,0,-Me/2,Ce,0,Me/2,Ce],l=null;for(let o=0;o<d.length;o+=3)a[0]=n[0]+.999*d[o]+.001*r(e),a[1]=n[1]+.999*d[o+1]+.001*r(t),a[2]=n[2]+.999*d[o+2],s[0]=n[0]+d[o]+e,s[1]=n[1]+d[o+1]+t,s[2]=n[2]+d[o+2],l=F(l,this.world.traceVector(a,s));return l?void(this.pos[0]+=e*l.dist,this.pos[1]+=t*l.dist):(this.pos[0]+=e,void(this.pos[1]+=t))},P.prototype.fall=function(e){function t(e){for(let t=0;t<s.length;t+=2){let r=s[t],n=s[t+1];if(d.get(r,n,e))return!0}return!1}this.falling=!0;let r=Z(this.pos[0]-Me/2),n=Z(this.pos[1]-Me/2),o=Z(this.pos[0]+Me/2),a=Z(this.pos[1]+Me/2),s=[];for(let t=r;t<=o;t++)for(let e=n;e<=a;e++)s.push(t,e);let d=this.world;if(0===e){let e=Z(this.pos[2]);return void(e===this.pos[2]&&t(e)&&(this.falling=!1))}if(0<e)for(;0<e;){let r=1<e?1:e,n=Z(this.pos[2]+Ce+r);if(t(n))return this.velocity[2]=0,void(this.pos[2]=n-Ce);this.pos[2]+=r,e-=r}if(0>e)for(;0>e;){let r=-1>e?-1:e,n=Z(this.pos[2]+r);if(t(n))return this.velocity[2]=0,this.falling=!1,void(this.pos[2]=n+1);this.pos[2]+=r,e-=r}};let Ue=[[0,0,0],[.9,.81,1],[.62,.81,1],[.3,.3,1]];const Se=[[-157,-231,30,"Divinity's Reach","Always turn around at the start."],[-172,-181,23,"Welcome to Shaemoor","It's just like you remember it."],[-86,-201,19,"The Graveyard","Exactly where this project will be tomorrow."],[-5,-274,7,"Beggar's Burror","It's a bit more sunny than it used to be."],[-229,-137,10,"Bridge to Shaemoor","BridgeWars?"],[-303,-140,9,"Diah's Farm","The cows are gone on vacation"],[-359,-249,1,"Divinity Dam","Dam, this took a loot of blocks to build."],[-389,-237,6,"Eda's Orchard","If you squint real hard, you can see the spiders"],[-325,-128,15,"The windmill","What else could it be?"],[-294,-111,12,"The sprinklers","Observe the flawless water physics."],[-303,-13,10,"Bandithound Caverns","Bandits stole the ceiling."],[-366,205,1,"Honeybees","Beware the Bears"],[-235,203,13,"Township of Claypool","Build your own houses. I'm tired."],[-221,189,14,"Shooting range","Hooooooooooooold"],[-50,225,12,"Heartwood Pass Camp","Held by Centaurs or Humans. Today, held by the void."],[138,264,2,"Kessex Hills","Sorry, there's no escape."],[183,136,1,"Temple of the Ages","Took you ages to get here, right?"],[120,149,0,"Deathroot Shack","There used to be raven here."],[365,226,23,"Righteous Hoofmoot","It's the Centaur Carusel!"],[397,196,26,"Demongrub Pits","Just press Jump and imagine you'd done it."],[379,-188,6,"Beetletun","Closed for renovations."],[213,-176,15,"Hunting Lodge","Someone call a carpenter."],[-74,-119,11,"Garrison","Say Hi to Logan from me."],[-252,-51,32,"Dalin's Pumping Station","No Diving!"],[191,4,14,"Eldvin Monastery","It's not a church. We're just brewing beer here."],[-91,27,4,"Altar Brook Trading Post","The perfect location, just between centaurs and bandits."]];class Pe{constructor(){this.removePopup=this.removePopup.bind(this),this.mesh=O(),this.mesh_count=this.mesh.length/6,this.stars=Se,this.found=this.stars.map(()=>!1),this.foundcount=0,this.e_popup=document.getElementById("starpopup"),this.e_popup_l1=document.getElementById("starpopup1"),this.e_popup_l2=document.getElementById("starpopup2"),this.e_found=document.getElementById("starsfound"),document.getElementById("starstotal").textContent=this.stars.length,this.timeout=null}tick(e){let t=Z(e[0]),r=Z(e[1]),n=Z(e[2]);for(let o=0;o<this.stars.length;o++){if(this.found[o])continue;let e=this.stars[o];if(e[0]===t&&e[1]===r&&e[2]===n)return void this.find(o)}}find(e){this.found[e]=!0,this.foundcount++,this.e_found.textContent=this.foundcount,this.e_popup.classList.add("visible"),this.e_popup_l1.textContent=this.stars[e][3],this.e_popup_l2.textContent=this.stars[e][4],this.timeout&&window.clearTimeout(this.timeout),this.timeout=window.setTimeout(this.removePopup,5e3)}removePopup(){this.timeout=null,this.e_popup.classList.remove("visible")}}window.BuildWars=class{constructor(e){if(this.onFocus=this.onFocusChange.bind(this,!0),this.onBlur=this.onFocusChange.bind(this,!1),this.start=this.start.bind(this),!!j()){let t=document.getElementById(e);if(!t)throw new Error("Cannot find canvas named "+e);this.canvas=t;let r=document.getElementById("loading_bg");r.onload=()=>this.init_files(),r.onerror=z,r.src="./start.jpg"}}init_files(){document.getElementById("loading_progress").textContent="Loading Game Files (~3 MB)...";let e={};fetch("./map.dat").then(e=>e.arrayBuffer()).then(t=>{e.map=t,this.init_game(e)}).catch(z);let t=new Image;t.onload=()=>{e.terrain=t,this.init_game(e)},t.onerror=z,t.src="./terrain.png"}init_game(e){e.map&&e.terrain&&(document.getElementById("loading_progress").textContent="Initializing Game...\n(takes a few seconds)",window.setTimeout(()=>this.init_game2(e),100))}init_game2(e){try{this.world=new Ee,this.loadMap(e.map),this.renderer=new M(this.canvas,e.terrain),e=null,this.player=new P(this.world),this.stars=new Pe,this.interactions=new Be(this.canvas,this.player),this.interactions.addHotkey("f10",()=>this.resetPlayer()),this.render=this.render.bind(this),this.stopped=!1,this.paused=!1,this.game_ticks=0,this.last_tick=!1,this.last_frame_time=!1,document.getElementById("loading_progress").textContent="Game loaded.";let t=document.getElementById("loading_start");t.classList.add("visible"),t.addEventListener("click",this.start,!1)}catch(t){z(t)}}start(){let e=document.getElementById("loading_start");e.removeEventListener("click",this.start,!1),e.classList.remove("visible"),document.getElementById("loading").classList.add("invisible"),window.addEventListener("focus",this.onFocus,!1),window.addEventListener("blur",this.onBlur,!1),requestAnimationFrame(this.render)}stop(){this.stopped=!0,window.removeEventListener("focus",this.onFocus,!1),window.removeEventListener("blur",this.onBlur,!1)}onFocusChange(e){this.paused=!e,this.last_tick=!1,this.last_frame_time=!1}saveMap(){function e(e){data.push((65280&e)>>8,255&e)}}loadMap(e){function t(){let e=r[n++],t=r[n++];return(e<<8)+t}let r=new Uint8Array(e),n=0,o=this.world,a=t(),i=t(),d=t();o.createEmptyWorld(a,i,d),a/=2,i/=2,d/=2;let l=0,u=0;for(let t=-a;t<a;t++)for(let e=-i;e<i;e++)for(let a=-d;a<d;a++)if(0>=l&&(l=r[n++],u=r[n++]),0===u){let e=d-a;e=W(l,e),a+=e-1,l-=e}else o.tree.set(t,e,a,u),l--;o.spawnPoint=s(-157,-229,29)}getClickVector(e,t,r){if(!t)return null;let n=o();return u(n,t,e),f(n,n,r/i(n)),l(n,e,n),n}resetPlayer(){for(let e=0;3>e;e++)this.player.pos[e]=this.world.spawnPoint[e],this.player.velocity[e]=0;this.player.angles[0]=0,this.player.angles[1]=X/2,this.player.angles[2]=0}render(){if(this.stopped)return;if(requestAnimationFrame(this.render),this.paused)return;let e=performance.now(),t=Date.now(),r=!1===this.last_tick?1:t-this.last_tick;this.last_tick=t,this.game_ticks+=r;let n=this.interactions.getMovement();this.player.update(r,n),-50>this.player.pos[2]&&this.resetPlayer(),this.stars.tick(this.player.pos);let a=o();l(a,this.player.pos,[0,0,1.7]);let i=24*(this.game_ticks/6e4)+12,s=N(i);this.renderer.prepareDraw(a,this.player.angles,s);let d=this.renderer.getClickPosition(this.interactions.mouse[0],this.interactions.mouse[1]),u=null;d&&(u=this.world.traceVector(a,this.getClickVector(a,d,20))),u&&(!this.player.buildDestroy&&(u.x+=u.face[0],u.y+=u.face[1],u.z+=u.face[2]),this.interactions.mousebuttons[0]&&this.player.interactWithBlock(u,r,t)),this.renderer.drawChunks(this.world),this.renderer.drawMarkers(u,this.player.buildDestroy?0:this.player.buildMaterial,this.player.crackedBlocks),this.renderer.drawStars(this.stars,this.game_ticks),this.renderer.drawWater(this.world.size),this.renderer.finishDraw();let c=performance.now(),f=!1===this.last_frame_time?1e3:c-this.last_frame_time;this.last_frame_time=c}}})();
