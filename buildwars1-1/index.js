(function(){'use strict';function a(a,b,c){let d=a.createShader(c);if(a.shaderSource(d,"#version 300 es\n"+b),a.compileShader(d),!a.getShaderParameter(d,a.COMPILE_STATUS))throw new Error("could not compile shader!\n"+a.getShaderInfoLog(d));return d}function b(a,b){if(b===a.FLOAT)return 4;throw new Error("Unknown type: "+b)}function c(a,b,c,d){let e=a.createTexture();return a.bindTexture(a.TEXTURE_2D_ARRAY,e),a.texImage3D(a.TEXTURE_2D_ARRAY,0,a.RGBA,c,c,d,0,a.RGBA,a.UNSIGNED_BYTE,b),a.texParameteri(a.TEXTURE_2D_ARRAY,a.TEXTURE_WRAP_S,a.REPEAT),a.texParameteri(a.TEXTURE_2D_ARRAY,a.TEXTURE_WRAP_T,a.REPEAT),a.texParameteri(a.TEXTURE_2D_ARRAY,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D_ARRAY,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.generateMipmap(a.TEXTURE_2D_ARRAY),a.bindTexture(a.TEXTURE_2D_ARRAY,null),e}function d(a,b,c){let d=a.createTexture();a.bindTexture(a.TEXTURE_2D,d),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,b,c,0,a.RGBA,a.UNSIGNED_BYTE,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);let e=a.createTexture();a.bindTexture(a.TEXTURE_2D,e),a.texImage2D(a.TEXTURE_2D,0,a.DEPTH_COMPONENT24,b,c,0,a.DEPTH_COMPONENT,a.UNSIGNED_INT,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);let f=a.createFramebuffer();return a.bindFramebuffer(a.FRAMEBUFFER,f),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,d,0),a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.TEXTURE_2D,e,0),a.bindFramebuffer(a.FRAMEBUFFER,null),a.bindTexture(a.TEXTURE_2D,null),{fb:f,rgba:d,depth:e,width:b,height:c}}function e(a,b,c,e){return b?b.width===c&&b.height===e?b:(a.deleteFramebuffer(b.fb),a.deleteTexture(b.rgba),a.deleteTexture(b.depth),d(a,c,e)):d(a,c,e)}function f(a){if(!S.has(a)){let b=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b),a.bufferData(a.ARRAY_BUFFER,R,a.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,null),S.set(a,b)}return S.get(a)}function g(a){let b=0;for(let d,c=4;0<=c;c--)d=255&a.charCodeAt(c),b+=d,b*=256;return b}function h(a,b){this.canvas=a;let d;try{d=a.getContext("webgl2")}catch(a){console.error(a)}if(!d)throw new Error("Your browser does not support WebGL2!");this.gl=d,d.enable(d.DEPTH_TEST),d.cullFace(d.BACK),d.enable(d.CULL_FACE),this.texture_blocks=c(this.gl,b,32,256),this.program=null,this.program_id=null,this.programs={},this.programs[g("block")]=new O(this.gl),this.programs[g("water")]=new P(this.gl),this.programs[g("stars")]=new Q(this.gl),this.programs[g("sky  ")]=new T(this.gl),this.chunk_vertices=new Map,this.buffers=new Map}function i(a){a.preventDefault(),a.stopPropagation()}function j(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja){try{a.start_frame(b,[c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r],[s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H],[I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X],[Y,Z,$],[_,aa],[ba,ca,da],[ea,fa,ga],[ha,ia,ja])}catch(b){console.error(b),a.broken=!0}}function k(a){try{a.finish_frame()}catch(b){console.error(b),a.broken=!0}}function l(a,b,c,d,e){try{a.set_buffer(b,c,d,e)}catch(b){console.error(b),a.broken=!0}}function m(a,b,c){try{a.set_buffer(b,c,null,0)}catch(b){console.error(b),a.broken=!0}}function n(a,b,c){try{a.broken||a.render_buffer(b,c)}catch(b){console.error(b),a.broken=!0}}function o(a,b,c,d){try{a.broken||a.render_buffer_instanced(b,c,d)}catch(b){console.error(b),a.broken=!0}}function p(a,b,c,d){Y||(Y=new X),Y.showNotification(b,c,d)}function q(a){return _[a]}function r(){return(null===aa||aa.buffer!==$.memory.buffer)&&(aa=new Float32Array($.memory.buffer)),aa}function s(a,b){return r().subarray(a/4,a/4+b)}function t(){return(null===ca||ca.buffer!==$.memory.buffer)&&(ca=new Uint8Array($.memory.buffer)),ca}function u(a,b){return ba.decode(t().subarray(a,a+b))}function v(a){da===_.length&&_.push(_.length+1);const b=da;return da=_[b],_[b]=a,b}function w(a){return $.init_game(v(a))}function x(a){const b=$.__wbindgen_malloc(1*a.length);return t().set(a,b/1),ea=a.length,b}function y(a){const b=x(a),c=ea;try{return $.load_map(b,c)}finally{$.__wbindgen_free(b,1*c)}}function z(a,b){return t().subarray(a/1,a/1+b)}function A(){return null===fa&&(fa=$.__wbindgen_global_argument_ptr()),fa}function B(){return(null===ga||ga.buffer!==$.memory.buffer)&&(ga=new Uint32Array($.memory.buffer)),ga}function C(){const a=A();$.save_map(a);const b=B(),c=b[a/4],d=b[a/4+1],e=z(c,d).slice();return $.__wbindgen_free(c,1*d),e}function D(a,b,c){return $.set_spawn_point(a,b,c)}function E(a,b,c,d,e,f,g,h,i,j,k,l,m){return $.tick(a,b,c,d,e,f,g,h,i,j,k,l,m)}function F(){return $.player_reset()}function G(){return $.player_get_x()}function H(){return $.player_get_y()}function I(){return $.player_get_z()}function J(a){36>a||(_[a]=da,da=a)}function K(a){let b;const c={"./client_web":Z};if(a instanceof URL||"string"==typeof a||a instanceof Request){const d=fetch(a);b="function"==typeof WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(d,c).catch(a=>(console.warn("`WebAssembly.instantiateStreaming` failed. Assuming this is because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",a),d.then(a=>a.arrayBuffer()).then(a=>WebAssembly.instantiate(a,c)))):d.then(a=>a.arrayBuffer()).then(a=>WebAssembly.instantiate(a,c))}else b=WebAssembly.instantiate(a,c).then(b=>b instanceof WebAssembly.Instance?{instance:b,module:a}:b);return b.then(a=>{let b=a.instance,c=a.module;return $=b.exports,K.__wbindgen_wasm_module=c,$})}function L(a){console.error(a);let b=a;a||(b="Unknown error"),"object"==typeof a&&"string"==typeof a.message&&(b=a.message),document.getElementById("loading_progress").textContent="Error loading game.\n".concat(b,"\nThis game is tested on Firefox and Chrome on a desktop computer.")}function M(){for(let a of["requestAnimationFrame","Float32Array","WebAssembly","fetch"])if(!window[a])return L("Your browser is too old."),!1;return!0}class N{constructor(c,d,e,f,g){this.gl=c,this.attributes=f||[],this.instanced_attributes=g||[];let h=0;for(let i of this.attributes)i[2]=h,h+=i[0]*b(c,i[1]);this.stride=h,h=0;for(let i of this.instanced_attributes)i[2]=h,h+=i[0]*b(c,i[1]);this.instanced_stride=h;let j=c.createProgram(),k=a(c,d,c.VERTEX_SHADER),i=a(c,e,c.FRAGMENT_SHADER);if(c.attachShader(j,k),c.attachShader(j,i),c.linkProgram(j),!c.getProgramParameter(j,c.LINK_STATUS))throw new Error("Could not link the shader program!\n"+c.getProgramInfoLog(j));c.useProgram(j);let l={},m=c.getProgramParameter(j,c.ACTIVE_UNIFORMS);for(let a=0;a<m;a++){let b=c.getActiveUniform(j,a),d=c.getUniformLocation(j,b.name);l[b.name]=d}let n={},o=c.getProgramParameter(j,c.ACTIVE_ATTRIBUTES);for(let a=0;a<o;a++){let b=c.getActiveAttrib(j,a),d=c.getAttribLocation(j,b.name);n[b.name]=d}c.useProgram(null),this.program=j,this.u=l,this.a=n}use(){let b=this.gl;for(let c in b.useProgram(this.program),this.a)b.enableVertexAttribArray(this.a[c]);this._use&&this._use()}stopUsing(){let b=this.gl;for(let c in b.useProgram(null),b.bindBuffer(b.ARRAY_BUFFER,null),this.a)b.disableVertexAttribArray(this.a[c]);this._stopUsing&&this._stopUsing()}drawBuffer(a,b){let c=this.gl;c.bindBuffer(c.ARRAY_BUFFER,a);for(let d,e=0;e<this.attributes.length;e++)d=this.attributes[e],c.vertexAttribPointer(e,d[0],d[1],!1,this.stride,d[2]);c.drawArrays(c.TRIANGLES,0,b)}drawBufferInstanced(a,b,c,d){let e=this.gl;e.bindBuffer(e.ARRAY_BUFFER,a);for(let f,g=0;g<this.attributes.length;g++)f=this.attributes[g],e.vertexAttribPointer(g,f[0],f[1],!1,this.stride,f[2]);e.bindBuffer(e.ARRAY_BUFFER,c);for(let f=0;f<this.instanced_attributes.length;f++){let b=this.instanced_attributes[f],a=f+this.attributes.length;e.vertexAttribPointer(a,b[0],b[1],!1,this.stride,b[2]),e.vertexAttribDivisor(a,1)}e.drawArraysInstanced(e.TRIANGLES,0,b,d);for(let f,g=0;g<this.instanced_attributes.length;g++)f=g+this.attributes.length,e.vertexAttribDivisor(f,0)}}class O extends N{constructor(a){super(a,"\nuniform mat4 uProjMatrix;\nuniform mat4 uViewMatrix;\n\nlayout(location = 0) in vec3 aPos;\nlayout(location = 1) in float aTexCoord;\n\nout vec3 vTexCoord;\nout vec3 vWorldPosition;\n\nconst vec2 tex_offsets[4] = vec2[] (\n\tvec2(0.0, 0.0),\n\tvec2(1.0, 0.0),\n\tvec2(0.0, 1.0),\n\tvec2(1.0, 1.0)\n);\n\nvoid main() {\n\tfloat tex_corner = round(mod(aTexCoord, 4.0)); // 0..3\n\tfloat tex_id = floor(aTexCoord / 4.0); // 0 .. 255\n\tvTexCoord = vec3(tex_offsets[int(tex_corner)], tex_id);\n\n\tvec4 viewPos = uViewMatrix * vec4(aPos, 1.0);\n\tgl_Position = uProjMatrix * viewPos;\n\n\tvWorldPosition = aPos;\n}","\nprecision highp float;\n\nuniform vec3 uSunColor;\nuniform vec3 uSunPosition;\n\nuniform highp sampler2DArray texBlocks;\n\nin vec3 vTexCoord;\nin vec3 vWorldPosition;\n\nout vec4 FragmentColor;\n\nvoid main() {\n\tvec3 dNormal = normalize(-cross(dFdx(vWorldPosition), dFdy(vWorldPosition)));\n\n\tfloat diffuseIntensity = max(dot(dNormal, uSunPosition), 0.0);\n\tvec3 lightColor = 0.5 * uSunColor + diffuseIntensity * uSunColor;\n\tlightColor = clamp(lightColor, 0.0, 1.0);\n\tvec4 color = texture(texBlocks, vTexCoord) * vec4(lightColor.rgb, 1.0);\n\tif (color.a < 0.01)\n\t\tdiscard;\n\n\tFragmentColor = vec4(color.rgb, 1.0);\n}",[[3,a.FLOAT],[1,a.FLOAT]])}}class P extends N{constructor(a){super(a,"\nuniform mat4 uProjMatrix;\nuniform mat4 uViewMatrix;\n\nuniform vec3 uAmbientColor;\n\nlayout(location = 0) in vec3 aPos;\nlayout(location = 1) in vec4 aColor;\n\nout vec4 vColor;\n\nvoid main() {\n\tgl_Position = uProjMatrix * uViewMatrix * vec4(aPos, 1.0);\n\tvColor = vec4(aColor.rgb * uAmbientColor, aColor.a);\n}","\nprecision highp float;\n\nin vec4 vColor;\n\nout vec4 FragmentColor;\n\nvoid main() {\n\tFragmentColor = vColor;;\n}",[[3,a.FLOAT],[4,a.FLOAT]])}_use(){let a=this.gl;a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA)}_stopUsing(){let a=this.gl;a.disable(a.BLEND)}}class Q extends N{constructor(a){super(a,"\nuniform mat4 uProjMatrix;\nuniform mat4 uViewMatrix;\nuniform float uTick;\n\nlayout(location = 0) in vec3 aPos; // vertex position; relative to model\nlayout(location = 1) in vec3 aPosition; // model position\n\nout vec3 vNormal;\nout vec3 vWorldPosition;\n\nvoid main() {\n\tfloat rotation = uTick; // 1 per second\n\tvec3 rotPos = vec3(\n\t\taPos.x * cos(rotation) - aPos.y * sin(rotation),\n\t\taPos.x * sin(rotation) + aPos.y * cos(rotation),\n\t\taPos.z\n\t);\n\tvec4 worldPos = vec4(rotPos + aPosition + 0.5, 1.0);\n\tvec4 viewPos = uViewMatrix * worldPos;\n\tgl_Position = uProjMatrix * viewPos;\n\n\tvWorldPosition = worldPos.xyz;\n}","\nprecision highp float;\n\nuniform vec3 uSunColor;\nuniform vec3 uSunPosition;\n\nin vec3 vWorldPosition;\n\nout vec4 FragmentColor;\n\nvoid main() {\n\tvec3 dNormal = normalize(-cross(dFdx(vWorldPosition), dFdy(vWorldPosition)));\n\n\tfloat diffuseIntensity = max(dot(dNormal, uSunPosition), 0.0);\n\tvec3 lightColor = 0.5 * uSunColor + diffuseIntensity * uSunColor;\n\tlightColor = clamp(lightColor, 0.0, 1.0);\n\tvec3 color = vec3(1.0, 1.0, 0.0) * lightColor;\n\n\tFragmentColor = vec4(color.rgb, 1.0);\n}",[[3,a.FLOAT]],[[3,a.FLOAT]])}}const R=new Float32Array([10,0,-10,10,-10,-10]);let S=new WeakMap;class T extends N{constructor(a){super(a,"\nlayout(location = 0) in vec2 aScreenPos;\n\nout vec2 vScreenPos;\n\nvoid main() {\n\tconst float Z = 0.5;\n\tgl_Position = vec4(aScreenPos, Z, 1.0); \n\n\tvScreenPos = aScreenPos;\n}","\nprecision highp float;\n\nuniform mat4 uInverseMatrix;\nuniform vec3 uCamera;\n\nuniform vec3 uSunPosition;\nuniform vec3 uFogColor;\nuniform vec2 uFogDistance;\n\nuniform sampler2D texColor;\nuniform sampler2D texDepth;\n\nin vec2 vScreenPos;\n\nout vec4 FragmentColor;\n\nvoid main() {\n\tvec2 texPos = (vScreenPos + 1.0) / 2.0;\n\tvec4 color = texture(texColor, texPos);\n\tfloat depth = texture(texDepth, texPos).r;\n\n\tvec4 world_pos4 = uInverseMatrix * vec4(vScreenPos, (depth * 2.0) - 1.0, 1.0);\n\tvec3 world_pos = world_pos4.xyz / world_pos4.w;\n\n\tvec3 look_vec = world_pos - uCamera;\n\tfloat distance = length(look_vec);\n\n\tfloat sun_angle = clamp(dot(normalize(look_vec), uSunPosition) * 1.001, 0.0, 1.0);\n\tfloat sun_intensity = pow(sun_angle, 100.0);\n\tvec3 sky_color = mix(uFogColor, vec3(1.0,1.0,1.0), sun_intensity);\n\n\tfloat fog = smoothstep(uFogDistance.x, uFogDistance.y, distance);\n\tcolor.rgb = mix(color.rgb, sky_color, fog);\n\n\tFragmentColor = vec4(color.rgb, 1.0);\n}")}drawRenderPass(a,b){let c=this.gl,d=this.u,e=f(c);c.bindBuffer(c.ARRAY_BUFFER,e),c.vertexAttribPointer(0,2,c.FLOAT,!1,8,0),c.uniform1i(d.texColor,0),c.activeTexture(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,a),c.uniform1i(d.texDepth,1),c.activeTexture(c.TEXTURE1),c.bindTexture(c.TEXTURE_2D,b),c.drawArrays(c.TRIANGLES,0,3),c.bindTexture(c.TEXTURE_2D,null),c.activeTexture(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,null)}}h.prototype.use_program=function(a){if(this.program_id===a)return this.program;if(this.program){if(this.program.u.texBlocks){let a=this.program.gl;a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D_ARRAY,null)}this.program.stopUsing(),this.program=null,this.program_id=null}if(a){if(!this.scene)throw new Error("use_program without an active scene: "+a);let b=this.programs[a];if(!b)throw new Error("Unknown program: "+a);this.program=b,this.program_id=a,b.use();let c=this.scene,d=b.u,e=b.gl;d.uTick&&e.uniform1f(d.uTick,c.tick/1e3),d.uProjMatrix&&e.uniformMatrix4fv(d.uProjMatrix,!1,c.projMatrix),d.uViewMatrix&&e.uniformMatrix4fv(d.uViewMatrix,!1,c.viewMatrix),d.uInverseMatrix&&e.uniformMatrix4fv(d.uInverseMatrix,!1,c.inverseMatrix),d.uCamera&&e.uniform3fv(d.uCamera,c.camera),d.uFogDistance&&e.uniform2fv(d.uFogDistance,c.fog),d.uFogColor&&e.uniform3fv(d.uFogColor,c.sky_color),d.uSunColor&&e.uniform3fv(d.uSunColor,c.ambient_color),d.uAmbientColor&&e.uniform3fv(d.uAmbientColor,c.ambient_color),d.uSunPosition&&e.uniform3fv(d.uSunPosition,c.sunpos),d.texBlocks&&(e.uniform1i(d.texBlocks,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D_ARRAY,this.texture_blocks))}return this.program},h.prototype.start_frame=function(a,b,c,d,f,g,h,i,j){const k=this.gl,l=this.canvas;(l.width!==l.clientWidth||l.height!==l.clientHeight)&&(l.width=l.clientWidth,l.height=l.clientHeight),this.scene={tick:a,projMatrix:new Float32Array(b),viewMatrix:new Float32Array(c),inverseMatrix:new Float32Array(d),camera:f,fog:g,sky_color:h,ambient_color:i,sunpos:j},this.projMatrix=new Float32Array(b),this.viewMatrix=new Float32Array(c),this.inverseMatrix=new Float32Array(d),this.camera=f,this.fog=g,this.sky={sky:h,ambient:i,sunpos:j},this.framebuffer=e(k,this.framebuffer,k.drawingBufferWidth,k.drawingBufferHeight),k.bindFramebuffer(k.FRAMEBUFFER,this.framebuffer.fb),k.viewport(0,0,k.drawingBufferWidth,k.drawingBufferHeight),k.clearColor(h[0],h[1],h[2],1),k.clear(k.COLOR_BUFFER_BIT|k.DEPTH_BUFFER_BIT),this.use_program(null)};g("block");h.prototype.set_buffer=function(a,b,c,d){const e=this.gl;let f=this.buffers;f.has(a)||f.set(a,new Map),f=f.get(a);let g=f.get(b)||{buffer:null,count:0};if(g.buffer&&(e.deleteBuffer(g.buffer),g.buffer=null),c&&0<c.length){let a=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,c,e.STATIC_DRAW),g.buffer=a,g.count=d,null}else g.buffer=!1,g.count=0;f.set(b,g)},h.prototype.render_buffer=function(a,b){let c=this.use_program(a),d=this.buffers.get(a);if(d){let a=d.get(b);a&&a.buffer&&c.drawBuffer(a.buffer,a.count)}},h.prototype.render_buffer_instanced=function(a,b,c){let d=this.use_program(a),e=this.buffers.get(a);if(!e)return;let f=e.get(b),g=e.get(c);f&&g&&f.buffer&&g.buffer&&d.drawBufferInstanced(f.buffer,f.count,g.buffer,g.count)},h.prototype.finish_frame=function(){const a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,null),a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),a.clearColor(0,0,0,1),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);let b=this.use_program(g("sky  "));b.drawRenderPass(this.framebuffer.rgba,this.framebuffer.depth),this.use_program(null),this.gl.finish()};const U=0,V=2;class W{constructor(a){this.element=a,this.keys={w:0,a:0,s:0,d:0," ":0,shift:0},this.turn_x=0,this.turn_y=0,this.skillchange=0,this.mouse=[-1,-1],this.lastmouse=[-1,-1],this.mousebuttons=[!1,!1],this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseOut=this.onMouseOut.bind(this),this.hotkeys=[],this.hotkeys_callbacks=[],this.running=!1,this.attached=!1,this.attach()}attach(){this.attached||(this.attached=!0,document.addEventListener("keydown",this.onKeyDown,!1),document.addEventListener("keyup",this.onKeyUp,!1),this.element.addEventListener("mouseup",this.onMouseUp,!1),this.element.addEventListener("mousedown",this.onMouseDown,!1),this.element.addEventListener("mousemove",this.onMouseMove,!1),this.element.addEventListener("mouseout",this.onMouseOut,!1),this.element.addEventListener("contextmenu",i,!1))}detach(){this.attached&&(this.attached=!1,document.removeEventListener("keydown",this.onKeyDown,!1),document.removeEventListener("keyup",this.onKeyUp,!1),this.element.removeEventListener("mouseup",this.onMouseUp,!1),this.element.removeEventListener("mousedown",this.onMouseDown,!1),this.element.removeEventListener("mousemove",this.onMouseMove,!1),this.element.removeEventListener("mouseout",this.onMouseOut,!1),this.element.removeEventListener("contextmenu",i,!1))}addHotkey(a,b){this.hotkeys.push(a),this.hotkeys_callbacks.push(b)}getMovement(){let a=1*this.keys.w+-1*this.keys.s,b=1*this.keys.d+-1*this.keys.a,c=this.keys[" "],d={fwd:a,side:b,running:this.running,jump:c,turn_x:this.turn_x,turn_y:this.turn_y,look_x:this.mouse[0],look_y:this.mouse[1],look_action:this.mousebuttons[0],skill:this.skillchange};return this.turn_x=0,this.turn_y=0,this.skillchange=0,d}onKeyDown(a){let b=a.key.toLowerCase();if("r"===b)this.running=!this.running;else if(-1<["1","2","3"].indexOf(b)){this.skillchange=+b}else if(-1<["w","a","s","d"," "].indexOf(b))this.keys[b]=1;else if(-1<this.hotkeys.indexOf(b)){let a=this.hotkeys.indexOf(b);this.hotkeys_callbacks[a](b)}else return;a.preventDefault()}onKeyUp(a){let b=a.key.toLowerCase();if(-1<["w","a","s","d"," "].indexOf(b))this.keys[b]=0;else return;a.preventDefault()}getMousePos(a){let b=this.element.getBoundingClientRect();this.mouse[0]=a.clientX-b.left,this.mouse[1]=a.clientY-b.top}onMouseDown(a){a.preventDefault(),this.getMousePos(a),a.button===U?this.mousebuttons[0]=!0:a.button===V&&(this.mousebuttons[1]=!0,this.lastmouse[0]=this.mouse[0],this.lastmouse[1]=this.mouse[1],this.element.style.cursor="move")}onMouseUp(a){a.preventDefault(),this.getMousePos(a),a.button===U?this.mousebuttons[0]=!1:a.button===V&&(this.mousebuttons[1]=!1,this.element.style.cursor="")}onMouseMove(a){a.preventDefault(),this.getMousePos(a),this.mousebuttons[1]&&(this.turn_x+=this.mouse[0]-this.lastmouse[0],this.turn_y+=this.mouse[1]-this.lastmouse[1],this.lastmouse[0]=this.mouse[0],this.lastmouse[1]=this.mouse[1])}onMouseOut(a){this.mouse[0]=-1,this.mouse[1]=-1,this.mousebuttons[0]=!1,this.mousebuttons[1]=!1}}class X{constructor(){this.removeNotification=this.removeNotification.bind(this),this.e_popup=document.getElementById("notification"),this.e_popup_l0=document.getElementById("notification0"),this.e_popup_l1=document.getElementById("notification1"),this.e_popup_l2=document.getElementById("notification2"),this.timeout=null,this.stars_found=0}showNotification(a,b,c){this.e_popup.classList.add("visible"),this.e_popup_l0.textContent=a,this.e_popup_l1.textContent=b,this.e_popup_l2.textContent=c;let d=document.getElementById("starsfound");d&&(this.stars_found++,d.textContent=this.stars_found),this.timeout&&window.clearTimeout(this.timeout),this.timeout=window.setTimeout(this.removeNotification,5e3)}removeNotification(){this.timeout&&window.clearTimeout(this.timeout),this.timeout=null,this.e_popup.classList.remove("visible")}}let Y=null;const Z={};let $;const _=Array(32);_.fill(void 0),_.push(void 0,null,!0,!1),Z.__wbg_startframe_62aedd95f143e596=function(a,b,c,d,e,f,g,h,i,k,l,m,n,o,p,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la){j(q(a),b>>>0,c,d,e,f,g,h,i,k,l,m,n,o,p,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la)},Z.__wbg_finishframe_fdb43acdb1ed2084=function(a){k(q(a))};let aa=null;Z.__wbg_setbuffer_794b805bc1205e88=function(a,b,c,d,e,f){let g=s(d,e);l(q(a),b,c,g,f>>>0)},Z.__wbg_deletebuffer_1181e1074d1d1905=function(a,b,c){m(q(a),b,c)},Z.__wbg_renderbuffer_d8da95fa3155a149=function(a,b,c){n(q(a),b,c)},Z.__wbg_renderbufferinstanced_41390fb35593443d=function(a,b,c,d){o(q(a),b,c,d)};let ba=new TextDecoder("utf-8"),ca=null;Z.__wbg_shownotification_7635b840211c35de=function(a,b,c,d,e,f,g){let h=u(b,c),i=u(d,e),j=u(f,g);p(q(a),h,i,j)};let da=_.length;Z.init_game=w;let ea=0;Z.load_map=y;let fa=null,ga=null;Z.save_map=C,Z.set_spawn_point=D,Z.tick=E,Z.player_reset=F,Z.player_get_x=G,Z.player_get_y=H,Z.player_get_z=I,Z.__wbindgen_object_drop_ref=function(a){J(a)};window.BuildWars=class{constructor(a){if(this.onFocus=this.onFocusChange.bind(this,!0),this.onBlur=this.onFocusChange.bind(this,!1),this.start=this.start.bind(this),!!M()){let b=document.getElementById(a);if(!b)throw new Error("Cannot find canvas named "+a);this.canvas=b;let c=document.getElementById("loading_bg");c.onload=()=>this.init_files(),c.onerror=L,c.src="./start.jpg"}}init_files(){document.getElementById("loading_progress").textContent="Loading Game Files (~3 MB)...";let a={};fetch("./map.dat").then(a=>a.arrayBuffer()).then(b=>{a.map=b,this.init_game(a)}).catch(L),K("./client_web_bg.wasm").then(b=>{a.wasm=b,this.init_game(a)});let b=new Image;b.onload=()=>{a.terrain=b,this.init_game(a)},b.onerror=L,b.src="./terrain.png"}init_game(a){a.map&&a.terrain&&a.wasm&&(document.getElementById("loading_progress").textContent="Initializing Game...\n(takes a few seconds)",window.setTimeout(()=>this.init_game2(a),100))}init_game2(a){try{this.renderer=new h(this.canvas,a.terrain),w(this.renderer),y(new Uint8Array(a.map)),D(-157,-229,29),a=null,F(),this.interactions=new W(this.canvas),this.interactions.addHotkey("f10",()=>F()),this.tick=this.tick.bind(this),this.stopped=!1,this.paused=!1,this.game_ticks=2,this.last_tick=!1,this.last_frame_time=!1,document.getElementById("loading_progress").textContent="Game loaded.";let b=document.getElementById("loading_start");b.classList.add("visible"),b.addEventListener("click",this.start,!1)}catch(a){L(a)}}start(){let a=document.getElementById("loading_start");a.removeEventListener("click",this.start,!1),a.classList.remove("visible"),document.getElementById("loading").classList.add("invisible"),window.addEventListener("focus",this.onFocus,!1),window.addEventListener("blur",this.onBlur,!1),requestAnimationFrame(this.tick)}stop(){this.stopped=!0,window.removeEventListener("focus",this.onFocus,!1),window.removeEventListener("blur",this.onBlur,!1)}onFocusChange(a){this.paused=!a,this.last_tick=!1,this.last_frame_time=!1}saveMap(){}tick(){if(this.stopped)return;if(this.renderer.broken)return;if(requestAnimationFrame(this.tick),this.paused)return;let a=performance.now(),b=Date.now(),c=!1===this.last_tick?1:b-this.last_tick;this.last_tick=b,this.game_ticks+=c;let d=this.interactions.getMovement();try{E(this.game_ticks,this.renderer.gl.drawingBufferWidth,this.renderer.gl.drawingBufferHeight,d.fwd,d.side,d.jump,d.running,d.turn_x,d.turn_y,d.look_x,d.look_y,d.look_action,d.skill)}catch(a){return console.error(a),void(this.renderer.broken=!0)}let e=[G(),H(),I()],f=performance.now();!1===this.last_frame_time?1e3:(f-this.last_frame_time[0])/this.last_frame_time.length;this.last_frame_time||(this.last_frame_time=[]),this.last_frame_time.push(f),10<this.last_frame_time.length&&this.last_frame_time.shift()}}})();
